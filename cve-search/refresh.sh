#!/usr/bin/env bash
set -euo pipefail

echo "[1] Pulling NVD delta (3 days buffer)"
docker compose exec cve_search \
  python3 /app/sbin/db_updater.py -d 2 # -s capec cpe cve cwe info via4

echo "[2] Pulling CVE-List V5 delta and rebuilding maps"
docker compose run --rm --no-deps cvelist_importer

# Ensure Python 3 and pip3 are available
sudo yum install -y python3
python3 -m ensurepip --upgrade

# Check and install pymongo if not present
python3 -c "import pymongo" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "Installing pymongo..."
    pip3 install --user pymongo
else
    echo "pymongo is already installed."
fi

# Check and install boto3 if not present
python3 -c "import boto3" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "Installing boto3..."
    pip3 install --user boto3
else
    echo "boto3 is already installed."
fi

# Computing both‐map diffs → SQS
python3 importer/diff_maps.py

echo "✔  All steps complete."
