#!/bin/bash

# === Configuration ===
DB_NAME="cvedb"
COLLECTIONS=("map_build_meta" "map_vendor_product_cvelistv5" "map_vendor_product_nvd")  # Add collections here
MONGO_CONTAINER="cve-searchdockerversion-mongo-1"
S3_BUCKET="cve-code"
S3_PATH="mongo_map_backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# === Create a working directory ===
WORKDIR="/tmp/mongo_exports_$TIMESTAMP"
mkdir -p "$WORKDIR"

# === Loop over collections and dump ===
for COLLECTION in "${COLLECTIONS[@]}"; do
    echo "Exporting $COLLECTION..."
    docker exec "$MONGO_CONTAINER" mongodump \
        --db="$DB_NAME" \
        --collection="$COLLECTION" \
        --out="/data/dump_$COLLECTION"

    docker cp "$MONGO_CONTAINER:/data/dump_$COLLECTION" "$WORKDIR/"
done

# === Compress all dumps ===
cd "$WORKDIR" || exit
TARFILE="mongodb_collections_$TIMESTAMP.tar.gz"
tar -czf "$TARFILE" ./*

# === Upload to S3 ===
echo "Uploading $TARFILE to S3..."
aws s3 cp "$TARFILE" "s3://$S3_BUCKET/$S3_PATH/$TARFILE"

# === Cleanup ===
echo "Cleaning up..."
rm -rf "$WORKDIR"
docker exec "$MONGO_CONTAINER" rm -rf /data/dump_*

echo "Done!"
